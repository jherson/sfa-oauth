<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:a4j="http://richfaces.org/a4j"
	xmlns:rich="http://richfaces.org/rich">

	<a4j:outputPanel id="viewQuoteProducts">

		<hr />

		<h:outputText value="#{msgs.quoteLineItems}" style="font-weight: bold" />

		<br />

		<rich:panel style="text-align: center; border: 0px;">		
				
			<a4j:commandButton value="#{msgs.copySelected}"
			    styleClass="commandButton"
			    rendered="#{quoteController.editMode}"
				action="#{quoteController.copyQuoteLineItems()}"
				disabled="#{empty selectedQuote.quoteLineItems}"
				render="quotedetails" ajaxSingle="true" />				
				
			<a4j:commandButton value="#{msgs.deleteSelected}"
			    styleClass="commandButton"
			    rendered="#{quoteController.editMode}"
				action="#{quoteController.deleteQuoteLineItems()}"
				disabled="#{empty selectedQuote.quoteLineItems}"
				render="quotedetails" ajaxSingle="true" 
				onclick="if (! window.confirm('#{msgs.confirmDelete}')) { return false };"/>	
				
			<a4j:commandButton value="#{msgs.reset}"
			    styleClass="commandButton" 
			    immediate="true"
			    rendered="#{quoteController.editMode}"
				disabled="#{empty selectedQuote.quoteLineItems}"
				action="#{quoteController.cancelEdit()}" render="quotedetails"
				ajaxSingle="true" />
				
			<a4j:commandButton value="#{msgs.getPrice}" 
			    styleClass="commandButton"
				rendered="#{not quoteController.editMode}"
				disabled="#{empty selectedQuote.quoteLineItems}"
				action="#{quoteController.priceQuote()}" ajaxSingle="true"
				render="quotedetails" />				
								
			<a4j:commandButton value="#{msgs.calculate}"
			    styleClass="commandButton" 
				rendered="#{not quoteController.editMode}"
				disabled="#{empty selectedQuote.quoteLineItems}"
				action="#{quoteController.calculateQuote()}" ajaxSingle="true"
				render="quotedetails"/>
            				
			<a4j:commandButton value="#{msgs.addOpportunityProducts}"
				styleClass="commandButton"
				rendered="#{not quoteController.editMode}"
				disabled="#{selectedQuote.currencyIsoCode != selectedQuote.opportunity.currencyIsoCode or not selectedQuote.opportunity.hasOpportunityLineItem}"
				action="#{quoteController.viewOpportunityLineItems()}"
				render="mainArea" />

			<a4j:commandButton value="#{msgs.addProduct}"
				styleClass="commandButton"
				rendered="#{not quoteController.editMode}"
				action="#{quoteController.newQuoteLineItem()}" render="quotedetails"
				ajaxSingle="true" />

			<a4j:commandButton value="#{msgs.goalSeek}"
				styleClass="commandButton"
				rendered="#{not quoteController.editMode}"
				action="#{quoteController.goalSeek()}" render="quotedetails"
				disabled="#{not selectedQuote.isCalculated}" />

		</rich:panel>

		<rich:dataTable id="quoteProductsTable" 
		    style="width: 100%"
			var="lineItem" 
			noDataLabel="#{msgs.noRecords}"
			iterationStatusVar="it" 
			value="#{selectedQuote.quoteLineItems}">

			<rich:column style="text-align: center; width: 3%;">
				<f:facet name="header">#{msgs.action}</f:facet>
				<a4j:commandLink id="deleteLineItem" value="#{msgs.delete}"
					rendered="#{not quoteController.editMode}"
					action="#{quoteController.deleteQuoteLineItem(lineItem)}"
					onclick="if (! window.confirm('#{msgs.confirmDelete}')) { return false };"
					render="quotedetails">
				</a4j:commandLink>
				<h:selectBooleanCheckbox value="#{lineItem.selected}"
					rendered="#{quoteController.editMode}" />
			</rich:column>
			
			<rich:column style="text-align: center; width: 3%;">
			    <f:facet name="header">#{msgs.lineNumber}</f:facet>
			
			<h:outputText value="#{lineItem.lineNumber}"
					rendered="#{not quoteController.editMode}" />
					
					<h:selectOneMenu
						value="#{lineItem.lineNumber}"
						rendered="#{quoteController.editMode}">
						<f:selectItems value="#{quoteController.lineNumberList}" />
						<f:attribute name="quoteLineItem" value="#{lineItem}" />
						<a4j:ajax execute="@this" event="valueChange"
							render="quoteProductsTable" status="waitstatus" />
						<a4j:actionListener listener="#{quoteLineItemListDataTableBean.reorderQuoteLineItem}" />
					</h:selectOneMenu>	
					
					<f:attribute name="quoteId" value="#{feedItem.parent.id}" />
								<a4j:ajax execute="@this" event="click" render="mainArea" />
								<a4j:actionListener listener="#{homeController.viewQuote}" />												
			
			</rich:column>

			<rich:column style="text-align: center; width: 9%;">
				<f:facet name="header">#{msgs.productCode}</f:facet>				
				
				<h:outputText value="#{lineItem.sku}"
					rendered="#{not quoteController.editMode}" />		
					
				<h:inputText id="productCode"
					value="#{lineItem.sku}" style="width: 100px;"
					rendered="#{quoteController.editMode}" execute="immediate"
					ajaxSingle="true">
					<f:attribute name="rowIndex" value="#{it.index}" />
					<a4j:ajax execute="@this" event="valueChange"
						listener="#{quoteLineItemListDataTableBean.validateProduct}"
						render="quoteProductsTable">
					</a4j:ajax>

				</h:inputText>
				<rich:message for="productCode" />
			</rich:column>

			<rich:column>
				<f:facet name="header">#{msgs.description}</f:facet>
				<h:outputText value="#{lineItem.description}" />
			</rich:column>

			<rich:column style="text-align: center; width: 8%;">
				<f:facet name="header">#{msgs.startDate}</f:facet>
				<h:outputText value="#{lineItem.startDate}"
					rendered="#{not quoteController.editMode or selectedQuote.type == 'Standard'}">
					<f:convertDateTime locale="#{sessionUser.locale}"
						pattern="#{sessionUser.dateFormatPattern}" type="date" />
				</h:outputText>
				<rich:calendar value="#{lineItem.startDate}"
					rendered="#{quoteController.editMode and selectedQuote.type != 'Standard'}"
					id="lineStartDate" locale="#{sessionUser.locale}" popup="true"
					enableManualInput="true" datePattern="#{sessionUser.dateFormatPattern}"
					showApplyButton="false" cellWidth="24px" cellHeight="22px"
					inputStyle="width:68px" disabled="false">
				</rich:calendar>
			</rich:column>

			<rich:column style="text-align: center; width: 8%;">
				<f:facet name="header">#{msgs.endDate}</f:facet>
				<h:outputText value="#{lineItem.endDate}"
					rendered="#{not quoteController.editMode or selectedQuote.type != 'Non Standard'}">
					<f:convertDateTime locale="#{sessionUser.locale}"
						pattern="#{sessionUser.dateFormatPattern}" type="date" />
				</h:outputText>
				<rich:calendar value="#{lineItem.endDate}"
					rendered="#{quoteController.editMode and selectedQuote.type == 'Non Standard'}"
					id="lineEndDate" locale="#{sessionUser.locale}" popup="true"
					enableManualInput="true" datePattern="#{sessionUser.dateFormatPattern}"
					showApplyButton="false" cellWidth="24px" cellHeight="22px"
					inputStyle="width:68px" disabled="false">
				</rich:calendar>
			</rich:column>

			<rich:column style="text-align: right; width: 5%;">
				<f:facet name="header">#{msgs.quantity}</f:facet>
				<h:outputText value="#{lineItem.quantity}"
					rendered="#{not quoteController.editMode}" />
				<h:inputText value="#{lineItem.quantity}" style="width: 50px;"
					rendered="#{quoteController.editMode}">
					<f:convertNumber locale="#{sessionUser.locale}" pattern="#,##0;(#,##0)"
						type="number" />
				</h:inputText>
			</rich:column>

			<rich:column style="text-align: right; width: 6%;">
				<f:facet name="header">#{msgs.listPrice}</f:facet>
				<h:outputText value="#{lineItem.listPrice}">
					<f:convertNumber locale="#{sessionUser.locale}"
						pattern="#,##0.00;(#,##0.00)" />
				</h:outputText>
				<s>  </s>
				<a4j:commandLink id="copyprice"
				    rendered="#{not empty lineItem.listPrice and quoteController.editMode}"
				    status="waitstatus">
				    <h:graphicImage value="./images/right-arrow.png" />
				    <f:attribute name="rowIndex" value="#{it.index}" />
					<a4j:ajax execute="@this" event="click"
						listener="#{quoteLineItemListDataTableBean.copyPrice}"
						render="yearlySalesPrice">
					</a4j:ajax>
				</a4j:commandLink>
			</rich:column>

			<rich:column style="text-align: right; width: 4%;">
				<f:facet name="header">#{msgs.discountPercent}</f:facet>
				<h:outputText value="#{lineItem.discountPercent}"
					rendered="#{not quoteController.editMode}">
					<f:convertNumber locale="#{sessionUser.locale}"
						pattern="#,##0.00;(#,##0.00)" />
				</h:outputText>
				<h:inputText value="#{lineItem.discountPercent}"
					style="width: 70px;" rendered="#{quoteController.editMode}">
					<f:convertNumber locale="#{sessionUser.locale}"
						pattern="#,##0.00;(#,##0.00)" type="number" />
				</h:inputText>
			</rich:column>

			<rich:column style="text-align: right; width: 4%;">
				<f:facet name="header">#{msgs.discountAmount}</f:facet>
				<h:outputText value="#{lineItem.discountAmount}"
					rendered="#{not quoteController.editMode}">
					<f:convertNumber locale="#{sessionUser.locale}"
						pattern="#,##0.00;(#,##0.00)" />
				</h:outputText>
				<h:inputText value="#{lineItem.discountAmount}" style="width: 70px;"
					rendered="#{quoteController.editMode}">
					<f:convertNumber locale="#{sessionUser.locale}"
						pattern="#,##0.00;(#,##0.00)" type="number" />
				</h:inputText>
			</rich:column>

			<rich:column style="text-align: right; width: 6%;">
				<f:facet name="header">#{msgs.salesPrice}</f:facet>				
				<h:outputText value="#{lineItem.yearlySalesPrice}"
				    rendered="#{not quoteController.editMode}">
				    <f:convertNumber locale="#{sessionUser.locale}"
					    pattern="#,##0.00;(#,##0.00)" />
				</h:outputText>
				<h:inputText 
				    value="#{lineItem.yearlySalesPrice}"
					style="width: 70px;" 
					rendered="#{quoteController.editMode}">
					<f:convertNumber locale="#{sessionUser.locale}"
						pattern="#,##0.00;(#,##0.00)" type="number" />					
				</h:inputText>								
			</rich:column>

			<rich:column style="text-align: right; width: 6%;">
				<f:facet name="header">#{msgs.unitPrice}</f:facet>
				<h:outputText value="#{lineItem.unitPrice}"
					rendered="#{not sessionManager.goalSeek}">
					<f:convertNumber locale="#{sessionUser.locale}"
						pattern="#,##0.00;(#,##0.00)" />
				</h:outputText>
				<h:inputText value="#{lineItem.unitPrice}" style="width: 70px;"
					rendered="#{sessionManager.goalSeek}">
					<f:convertNumber locale="#{sessionUser.locale}"
						pattern="#,##0.00;(#,##0.00)" type="number" />
				</h:inputText>
			</rich:column>

			<rich:column style="text-align: right; width: 6%;">
				<f:facet name="header">#{msgs.totalPrice}</f:facet>
				<h:outputText value="#{lineItem.totalPrice}"
				    rendered="#{not sessionManager.goalSeek}">
					<f:convertNumber locale="#{sessionUser.locale}"
						pattern="#,##0.00;(#,##0.00)" />
				</h:outputText>		
				<h:inputText value="#{lineItem.totalPrice}" style="width: 70px;"
					rendered="#{sessionManager.goalSeek}">
					<f:convertNumber locale="#{sessionUser.locale}"
						pattern="#,##0.00;(#,##0.00)" type="number" />
				</h:inputText>	
			</rich:column>			
			
			<rich:column style="text-align: center; width: 2%;">
				<f:facet name="header"></f:facet>
				<h:graphicImage value="./images/bullet-yellow.png" 
					rendered="#{empty lineItem.code or lineItem.code == 'NOT PRICED'}"/>
				<h:graphicImage value="./images/bullet-green.png" 
					rendered="#{lineItem.code == 'SUCCESS'}"/>
				<h:graphicImage value="./images/bullet-red.png" 
					rendered="#{lineItem.code == 'FAILURE'}"
					tooltip="#{lineItem.message}"/>		
			</rich:column>					
						
			<f:facet name="footer">
			    <h:outputText value="#{msgs.lineCount}: #{selectedQuote.quoteLineItems.size()}, #{msgs.amount}: (#{selectedQuote.currencyIsoCode}) "/>
			    <h:outputText value="#{selectedQuote.amount}">
                    <f:convertNumber locale="#{sessionUser.locale}"
						pattern="#,##0.00;(#,##0.00)" />
                    </h:outputText>
			</f:facet>

		</rich:dataTable>
	</a4j:outputPanel>
</ui:composition>